---
description: 智能更新技术文档（API接口和数据库表结构）
---

## 用户输入

```text
$ARGUMENTS
```

## 概述

此命令用于智能更新技术文档，确保技术文档与实际开发保持同步。命令会：
1. 理解用户描述的技术变更
2. 自动识别需要更新的文档部分
3. 智能合并到现有文档中
4. 保持文档的连贯性和完整性

## 执行流程

### 1. 理解用户输入

接受多种输入形式：

**直接描述变更**（推荐）：
```
新增用户导出接口：GET /admin/user/export
支持按角色、状态筛选，导出 Excel 格式
需要管理员权限
```

**从 Markdown 文件读取**：
```
/spec.tech-doc ./api-changes.md
```

**描述数据库变更**：
```
user 表新增 avatar 字段（VARCHAR(255)），用于存储头像 URL
新增 user_preferences 表，存储用户偏好设置
```

### 2. 智能识别变更类型

自动判断是 API 变更还是数据库变更：

**API 变更的标志**：
- 包含 HTTP 方法（GET/POST/PUT/DELETE）
- 包含路径（/xxx/xxx）
- 提到"接口"、"请求"、"响应"
- 提到认证、权限

**数据库变更的标志**：
- 提到"表"、"字段"、"列"
- 包含数据类型（VARCHAR/INT/BIGINT/JSON/DATETIME）
- 提到"索引"、"主键"、"外键"
- 提到"关联"、"关系"

**混合变更**：
同时包含以上两类信息

### 3. 提取关键信息

#### 对于 API 变更，提取：

**接口基本信息**：
- 接口路径和方法
- 功能描述（做什么用的）
- 所属模块（从路径推断，如 /admin/user → 用户管理）

**请求信息**：
- 路径参数（如 /user/:id）
- 查询参数（如 ?status=active）
- 请求体参数（JSON 格式）
- 每个参数的：名称、类型、是否必填、说明

**响应信息**：
- 成功响应的数据结构
- 常见错误码和说明

**权限要求**：
- 是否需要登录
- 需要什么角色/权限

#### 对于数据库变更，提取：

**表信息**：
- 表名（转换为小写+下划线格式）
- 表的功能说明
- 所属模块

**字段信息**：
- 字段名
- 数据类型
- 是否可空
- 默认值
- 字段说明

**索引和约束**：
- 主键
- 唯一索引
- 普通索引
- 外键关系

### 4. 加载现有文档

读取当前的技术文档：
- `docs/技术文档/API接口文档.md`
- `docs/技术文档/数据库表结构.md`

解析现有文档结构，了解：
- 已有的接口和表
- 文档的组织方式（按模块分类）
- 目录结构

### 5. 智能合并更新

#### 新增内容

**新接口/新表**：
- 找到对应的模块章节
- 如果模块不存在，创建新模块
- 按照现有格式插入新内容
- 更新目录索引

**示例**：
```
用户描述：新增活动签到接口 POST /activity/sign-in
→ 识别模块：活动管理
→ 查找文档中的"活动管理"章节
→ 在该章节添加新接口
→ 更新文档顶部的目录链接
```

#### 修改内容

**接口/表已存在**：
- 定位到具体的接口或表
- 对比差异（新增字段、修改类型、删除参数）
- 只更新变更的部分，保留未变更的内容
- 在变更处添加注释（如：`<!-- 2024-01-15 新增 -->`）

**示例**：
```
用户描述：活动表新增 max_participants 字段
→ 定位到 activity 表
→ 在字段列表中添加新字段
→ 保持其他字段不变
```

#### 废弃内容

如果用户明确说明某接口/字段废弃：
- 不删除，而是标记为"已废弃"
- 添加废弃说明和时间
- 建议替代方案（如果有）

### 6. 补充推断信息

基于上下文和最佳实践，智能补充信息：

**API 接口补充**：
- 根据路径推断所属模块
- 根据方法推断操作类型（GET 查询、POST 创建、PUT 更新、DELETE 删除）
- 根据功能推断可能的错误码（如：404 未找到、403 无权限）
- 推断通用的响应格式（基于项目现有接口）

**数据库表补充**：
- 自动添加通用字段（creation_date, modified_date）
- 推断主键（通常是 id）
- 推断字段的可空性（关键字段设为 NOT NULL）
- 推断索引需求（如：唯一标识字段需要唯一索引）

**重要**：推断的信息会在文档中标注"（推断）"，提醒后续人工确认。

### 7. 保持文档连贯性

**模块分组**：
按照现有的模块分类，将新内容归入正确的模块。

**命名一致性**：
- API 路径风格保持一致（如都用 /admin/user 而不是 /adminUser）
- 数据库表名和字段名遵循项目命名规范

**描述语言**：
- 保持与现有文档相同的描述风格
- 使用简洁清晰的语言
- 避免技术黑话，用业务语言描述

### 8. 生成变更摘要

输出更新报告：

```markdown
## 技术文档更新报告

### 更新时间
2024-01-15 14:30

### API 接口文档变更
- [新增] POST /activity/sign-in - 活动签到接口
- [修改] GET /admin/user - 新增 role 查询参数
- [废弃] DELETE /old-api - 已被新接口替代

### 数据库表结构变更
- [新增] activity_sign 表 - 活动签到记录表
- [修改] user 表 - 新增 avatar 字段
- [修改] activity 表 - 新增 max_participants 字段

### 需要关注
- activity_sign 表的索引配置待确认
- POST /activity/sign-in 的并发控制待补充
```

### 9. 输出文档路径

告知用户更新后的文档位置：
- API 接口文档：`docs/技术文档/API接口文档.md`
- 数据库表结构：`docs/技术文档/数据库表结构.md`

## 智能处理示例

### 示例 1：从代码变更推断

用户输入：
```
我刚实现了用户头像上传功能
```

AI 推断并更新：
- **API 文档**：
  - 新增 POST /user/avatar - 上传用户头像
  - 参数：file (文件), userId (string)
  - 响应：返回头像 URL
- **数据库文档**：
  - user 表新增 avatar 字段 (VARCHAR(255))

### 示例 2：从业务需求推断

用户输入：
```
活动需要限制报名人数
```

AI 推断并更新：
- **API 文档**：
  - 修改 POST /activity/sign - 新增人数检查逻辑
  - 新增错误码 4001 - 报名人数已满
- **数据库文档**：
  - activity 表新增 max_participants 字段 (INT)
  - activity 表新增 current_participants 字段 (INT, 默认 0)

### 示例 3：技术优化

用户输入：
```
用户列表接口需要支持分页
```

AI 推断并更新：
- **API 文档**：
  - 修改 GET /admin/user
  - 新增查询参数：page (INT, 默认 1), pageSize (INT, 默认 20)
  - 响应格式变更：增加 total, page, pageSize 字段

## 注意事项

1. **保持同步**：技术文档应该与代码实现保持同步，建议每次 API 或数据库变更后及时更新

2. **向后兼容**：API 变更时考虑向后兼容性，重大变更建议使用新的版本号（如 /v2/）

3. **数据迁移**：数据库结构变更要考虑数据迁移方案，在文档中注明迁移注意事项

4. **权限控制**：新增接口要明确权限要求，确保安全性

5. **与代码对照**：更新文档后，建议与实际代码实现对照，确保一致性

6. **AI 可读性优先**：文档的首要目标是让 AI 能够理解并基于文档进行开发，所以要：
   - 描述清晰的业务逻辑
   - 说明参数的业务含义（不只是技术定义）
   - 包含典型的使用场景和示例
   - 注明边界条件和异常情况
